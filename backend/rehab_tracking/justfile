# Rehab Exercise Tracking - Developer Commands
# Justfile for streamlined development workflow
#
# Usage:
#   just setup    - Install deps and setup database  
#   just test     - Run all test suites
#   just smoke    - Run smoke tests
#   just server   - Start Phoenix development server
#   just doctor   - Health check and compile

# Default recipe
default:
    @just --list

# Setup development environment
setup:
    @echo "ğŸš€ Setting up Rehab Exercise Tracking development environment..."
    @echo "ğŸ“¦ Installing dependencies..."
    mix deps.get
    @echo "ğŸ—„ï¸  Setting up databases..."
    mix ecto.setup
    @echo "ğŸ“‹ Initializing EventStore..."
    mix event_store.init
    @echo "âœ… Setup complete! Run 'just server' to start development."

# Run all test suites (contract, integration, E2E, unit)
test:
    @echo "ğŸ§ª Running complete test suite..."
    @echo "ğŸ“‹ Contract tests..."
    mix test test/contract --cover
    @echo "ğŸ”— Integration tests..."
    mix test test/integration --cover 
    @echo "ğŸ¯ E2E tests..."
    mix test test/e2e --cover
    @echo "ğŸ” Unit tests..."
    mix test test/unit --cover
    @echo "ğŸ“Š Overall coverage report..."
    mix test --cover

# Run smoke tests for quick validation
smoke:
    @echo "ğŸ’¨ Running smoke tests..."
    mix run priv/smoke/smoke.exs

# Start Phoenix development server
server:
    @echo "ğŸŒ Starting Phoenix development server..."
    @echo "ğŸ“ Server will be available at http://localhost:4000"
    iex -S mix phx.server

# Development health check
doctor:
    @echo "ğŸ‘©â€âš•ï¸ Running development health checks..."
    @echo "âš™ï¸  Compile check with strict warnings..."
    mix compile --warnings-as-errors
    @echo "ğŸ§ª Quick test validation..."
    mix test --max-failures 1
    @echo "ğŸ“Š Dependencies status..."
    mix deps.unlock --check-unused
    @echo "ğŸ¥ All systems healthy!"

# Clean build artifacts  
clean:
    @echo "ğŸ§¹ Cleaning build artifacts..."
    mix deps.clean --all
    mix clean
    rm -rf _build/
    @echo "âœ¨ Clean complete!"

# Reset development database
reset-db:
    @echo "ğŸ—„ï¸  Resetting development database..."
    mix ecto.reset
    mix event_store.reset
    @echo "â™»ï¸  Database reset complete!"

# Start services (Docker) - Development mode
services-up:
    @echo "ğŸ³ Starting PostgreSQL, Redis, and RabbitMQ (dev mode)..."
    docker-compose -f docker-compose.dev.yml up -d
    @echo "â³ Waiting for services to be healthy..."
    docker-compose -f docker-compose.dev.yml ps

# Stop services (Docker)  
services-down:
    @echo "ğŸ›‘ Stopping development services..."
    docker-compose -f docker-compose.dev.yml down
    @echo "ğŸ§¹ Services stopped!"

# Start full production stack
services-full:
    @echo "ğŸ³ Starting full production-like stack..."
    docker-compose up -d
    @echo "â³ Waiting for all services to be healthy..."
    docker-compose ps

# View service logs (dev mode by default)
logs service="postgres" compose="docker-compose.dev.yml":
    @echo "ğŸ“‹ Viewing logs for {{ service }}..."
    docker-compose -f {{ compose }} logs -f {{ service }}

# Run in production-like mode
prod-test:
    @echo "ğŸ­ Testing in production-like environment..."
    MIX_ENV=prod mix compile --warnings-as-errors
    MIX_ENV=prod mix test
    @echo "ğŸš€ Production test complete!"

# Generate code coverage report
coverage:
    @echo "ğŸ“Š Generating detailed coverage report..."
    mix test --cover
    mix coveralls.html
    @echo "ğŸ“„ Coverage report available at cover/excoveralls.html"

# Format code
format:
    @echo "ğŸ¨ Formatting Elixir code..."
    mix format
    @echo "âœ¨ Code formatting complete!"

# Security audit
security:
    @echo "ğŸ” Running security audit..."
    mix sobelow
    @echo "ğŸ›¡ï¸  Security audit complete!"

# Performance benchmarks  
benchmark:
    @echo "âš¡ Running performance benchmarks..."
    mix run priv/benchmarks/event_ingestion.exs
    @echo "ğŸ“ˆ Benchmark complete!"